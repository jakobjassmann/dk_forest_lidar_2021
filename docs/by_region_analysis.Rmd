---
title: "DK Forest LiDAR - Model Performance by Region"
author: "Jakob Assmann"
date: "23/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(sf)
library(caret)
library(tidyverse)
library(ggplot2)
```

## Performance by region

```{r prep, echo = FALSE, results='hide'}
# Load vaidation data
load("../data/training_data/pixel_valid_biowide.Rda")

# Load model
load("../data/final_gbm_model_pixel.Rda")

# Load regions
biowide_regions <- read_sf("../data/stratification/biowide_georegions/biowide_zones.shp")
```

# Map of regions

``` {r map_of_regions, echo = FALSE}
ggplot() + geom_sf(aes(fill = region), data = biowide_regions)
```

## Performance by region

```{r perf_by_region, echo=FALSE}
pixel_valid_biowide %>% group_split() %>%
  map(function(test_data_region){
    test_preds_region <- predict(gbm_fit, newdata = test_data_region)
    cat(unique(test_data_region$biowide_region), "\n")
    print(confusionMatrix(data = test_preds_region, test_data_region$forest_value))
    return(NULL)
  })
```

# Performance by forest type

```{r perf_by_forest_type, echo=FALSE}
pixel_valid_biowide %>% 
  mutate(forest_type = forest_type_cloud + 2 * forest_type_con + 3 * forest_type_dec) %>%
  mutate(forest_type = ordered(forest_type, levels = c(1,2,3))) %>% 
  split(.$forest_type) %>%
  setNames(., c("Cloudy", "Coniferous", "Broadleaf")) %>%
  map(function(test_data_region){
    test_preds_region <- predict(gbm_fit, newdata = test_data_region)
    confusionMatrix(data = test_preds_region, test_data_region$forest_value)
  })
```
